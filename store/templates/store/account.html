{% extends 'store/base.html' %}
{% load static %}
{% block title %}My Account — AKVRIX{% endblock %}
{% block nav_class %}scrolled{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <h1>My Account</h1>
    <div class="breadcrumb"><a href="{% url 'shop' %}">Shop</a> / <span>Account</span></div>
  </div>
</div>

<section class="section">
  <div class="container">
    <div class="account-layout">
      <aside class="account-sidebar">
        <div class="user-info">
          <div class="user-avatar">{{ user.first_name|first|default:"U" }}</div>
          <h4>{{ user.get_full_name|default:user.username }}</h4>
          <p style="font-size:.78rem;color:var(--text-muted)">{{ user.email }}</p>
        </div>
        <ul>
          <li><a href="#" class="active" onclick="showTab('orders',this);return false"><i
                class="ri-shopping-bag-line"></i> Orders</a></li>
          <li><a href="#" onclick="showTab('wishlist',this);return false"><i class="ri-heart-line"></i> Wishlist</a>
          </li>
          <li><a href="#" onclick="showTab('profile',this);return false"><i class="ri-user-line"></i> Profile</a></li>
          <li><a href="#" onclick="showTab('settings',this);return false"><i class="ri-settings-3-line"></i>
              Settings</a></li>
          <li><a href="{% url 'logout' %}" style="color:var(--danger)"><i class="ri-logout-box-line"></i> Logout</a>
          </li>
        </ul>
      </aside>

      <div class="account-content" id="accountTab">
        <h3 style="margin-bottom:1.5rem">Order History</h3>
        {% if orders %}
        {% for order in orders %}
        <div class="order-card">
          <div class="order-header">
            <div><strong>{{ order.order_number }}</strong><span> — {{ order.created_at|date:"M d, Y" }}</span></div>
            <span class="order-status {{ order.status }}">{{ order.get_status_display }}</span>
          </div>
          <p style="font-size:.82rem;color:var(--text-secondary)">{% for item in order.items.all %}{{ item.product_name
            }} x {{ item.quantity }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.5rem">
            <p style="font-size:.9rem;font-weight:600;color:var(--accent)">₹{{ order.total }}</p>
            <a href="{% url 'order_detail_page' order.order_number %}" style="font-size:.8rem;color:var(--accent)">View
              Details →</a>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div style="text-align:center;padding:3rem 0;color:var(--text-secondary)">
          <i class="ri-shopping-bag-line" style="font-size:3rem;opacity:.3"></i>
          <p style="margin-top:1rem">No orders yet. <a href="{% url 'shop' %}" style="color:var(--accent)">Start
              shopping</a></p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  const userData = {
    firstName: '{{ user.first_name|escapejs }}',
    lastName: '{{ user.last_name|escapejs }}',
    email: '{{ user.email|escapejs }}',
  };

  function showTab(tab, link) {
    const el = document.getElementById('accountTab');
    if (link) {
      document.querySelectorAll('.account-sidebar a').forEach(a => a.classList.remove('active'));
      link.classList.add('active');
    }
    if (tab === 'orders') {
      location.reload();
    } else if (tab === 'wishlist') {
      let html = '<h3 style="margin-bottom:1.5rem">Wishlist</h3>';
      {% if wishlist %}
      html += '<div class="wishlist-grid">';
      {% for w in wishlist %}
      html += `<div class="product-card" style="text-align:center">
      <a href="/product/{{ w.product.slug }}/">
        <img src="{{ w.product.image }}" alt="{{ w.product.name }}" style="width:100%;border-radius:8px;margin-bottom:.5rem">
      </a>
      <p style="font-weight:600">{{ w.product.name|escapejs }}</p>
      <p style="color:var(--accent)">₹{{ w.product.price }}</p>
    </div>`;
      {% endfor %}
      html += '</div>';
      {% else %}
      html += '<div style="text-align:center;padding:3rem 0;color:var(--text-secondary)"><i class="ri-heart-line" style="font-size:3rem;opacity:.3"></i><p style="margin-top:1rem">Your wishlist is empty. <a href="/shop/" style="color:var(--accent)">Explore products</a></p></div>';
      {% endif %}
      el.innerHTML = html;
    } else if (tab === 'profile') {
      el.innerHTML = `<h3 style="margin-bottom:1.5rem">Profile Settings</h3>
      <div id="profileMsg"></div>
      <div class="form-grid">
        <div class="form-group"><label>First Name</label><input type="text" id="profFirst" value="${userData.firstName}"></div>
        <div class="form-group"><label>Last Name</label><input type="text" id="profLast" value="${userData.lastName}"></div>
        <div class="form-group full"><label>Email</label><input type="email" id="profEmail" value="${userData.email}"></div>
      </div>
      <button class="btn btn-primary" style="margin-top:1rem" onclick="saveProfile()">Save Changes</button>`;
    } else if (tab === 'settings') {
      el.innerHTML = `<h3 style="margin-bottom:1.5rem">Change Password</h3>
      <div id="pwMsg"></div>
      <div class="form-group"><label>Current Password</label><input type="password" id="pwCurrent" placeholder="Enter current password" style="margin-bottom:.5rem"></div>
      <div class="form-group"><label>New Password</label><input type="password" id="pwNew" placeholder="Enter new password" style="margin-bottom:.5rem"></div>
      <div class="form-group"><label>Confirm New Password</label><input type="password" id="pwConfirm" placeholder="Confirm new password"></div>
      <button class="btn btn-primary" style="margin-top:1rem" onclick="changePassword()">Update Password</button>`;
    }
  }

  function saveProfile() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/profile/update/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify({
        first_name: document.getElementById('profFirst').value,
        last_name: document.getElementById('profLast').value,
        email: document.getElementById('profEmail').value,
      })
    })
      .then(r => r.json())
      .then(data => {
        const msg = document.getElementById('profileMsg');
        if (data.success) {
          msg.innerHTML = '<div class="auth-error" style="background:rgba(0,200,100,.1);color:#0c6">✓ Profile updated successfully!</div>';
          userData.firstName = document.getElementById('profFirst').value;
          userData.lastName = document.getElementById('profLast').value;
          userData.email = document.getElementById('profEmail').value;
          // Update sidebar & navbar
          const fullName = (userData.firstName + ' ' + userData.lastName).trim();
          document.querySelector('.user-info h4').textContent = fullName || userData.email;
          const navName = document.querySelector('.nav-user-name');
          if (navName) navName.textContent = fullName || userData.email;
          document.querySelector('.user-avatar').textContent = userData.firstName.charAt(0).toUpperCase() || 'U';
        } else {
          msg.innerHTML = '<div class="auth-error"><i class="ri-error-warning-line"></i> ' + data.error + '</div>';
        }
      });
  }

  function changePassword() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/password/change/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
      body: JSON.stringify({
        current_password: document.getElementById('pwCurrent').value,
        new_password: document.getElementById('pwNew').value,
        confirm_password: document.getElementById('pwConfirm').value,
      })
    })
      .then(r => r.json())
      .then(data => {
        const msg = document.getElementById('pwMsg');
        if (data.success) {
          msg.innerHTML = '<div class="auth-error" style="background:rgba(0,200,100,.1);color:#0c6">✓ Password changed successfully!</div>';
          document.getElementById('pwCurrent').value = '';
          document.getElementById('pwNew').value = '';
          document.getElementById('pwConfirm').value = '';
        } else {
          msg.innerHTML = '<div class="auth-error"><i class="ri-error-warning-line"></i> ' + data.error + '</div>';
        }
      });
  }
</script>
{% endblock %}