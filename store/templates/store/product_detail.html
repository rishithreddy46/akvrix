{% extends 'store/base.html' %}
{% load static %}

{% block title %}{{ product.name }} — AKVRIX{% endblock %}
{% block nav_class %}scrolled{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="breadcrumb"><a href="{% url 'home' %}">Home</a> / <a href="{% url 'shop' %}">Shop</a> / <span>{{
                product.name }}</span></div>
    </div>
</div>

<section class="section">
    <div class="container">
        <div class="product-detail">
            <!-- Gallery -->
            <div>
                <div class="gallery-main" id="mainGallery">
                    <img src="{{ product.image }}" alt="{{ product.name }}" id="mainImg">
                </div>
                <div class="gallery-thumbs">
                    <img src="{{ product.image }}" alt="View 1" class="active" onclick="switchImg(this)">
                    {% if product.image_hover %}
                    <img src="{{ product.image_hover }}" alt="View 2" onclick="switchImg(this)">
                    {% endif %}
                </div>
            </div>

            <!-- Details -->
            <div class="product-details">
                {% if product.badge %}
                <span class="product-badge {% if product.badge == 'Limited' %}limited{% endif %}"
                    style="position:static;margin-bottom:1rem;display:inline-block">{{ product.badge }}</span>
                {% endif %}
                <h1>{{ product.name }}</h1>
                <div class="price-block">
                    <span class="current">₹{{ product.price }}</span>
                    {% if product.old_price %}
                    <span class="old">₹{{ product.old_price }}</span>
                    <span class="save">Save {{ product.discount_percent }}%</span>
                    {% endif %}
                </div>
                <div class="rating-block">
                    <i class="ri-star-fill"></i><i class="ri-star-fill"></i><i class="ri-star-fill"></i><i
                        class="ri-star-fill"></i>
                    {% if product.rating >= 4.5 %}
                    <i class="ri-star-fill"></i>
                    {% else %}
                    <i class="ri-star-half-fill"></i>
                    {% endif %}
                    <span>{{ product.rating }} ({{ product.reviews_count }} reviews)</span>
                </div>
                <p class="desc">{{ product.description }}</p>

                <!-- Size Selector -->
                <div class="selector-group">
                    <label>Size</label>
                    <div class="size-options" id="sizeOptions">
                        {% for s in product.get_sizes_list %}
                        <button class="size-btn {% if forloop.counter == 2 %}active{% endif %}"
                            onclick="document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');selectedSize='{{ s }}'">{{
                            s }}</button>
                        {% endfor %}
                    </div>

                </div>

                <!-- Color Selector -->
                <div class="selector-group">
                    <label>Color</label>
                    <div class="color-options-detail" id="colorOptions">
                        {% for c in product.get_colors_list %}
                        <button class="color-btn {% if forloop.first %}active{% endif %}" style="background:{{ c }}"
                            onclick="document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');selectedColor='{{ c }}'"></button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quantity -->
                <div class="selector-group">
                    <label>Quantity</label>
                    <div class="qty-selector">
                        <button onclick="changeQty(-1)"><i class="ri-subtract-line"></i></button>
                        <input type="number" value="1" min="1" max="10" id="qtyInput" readonly>
                        <button onclick="changeQty(1)"><i class="ri-add-line"></i></button>
                    </div>
                </div>

                <div class="detail-btns">
                    <button class="btn btn-primary btn-lg" onclick="addToCartDetail()"><i
                            class="ri-shopping-bag-line"></i> Add to Cart</button>
                    <button class="btn btn-outline btn-lg" onclick="toggleWishlistAPI({{ product.id }}, this)"><i
                            class="ri-heart-line"></i> Add to Wishlist</button>
                </div>

                <!-- Features -->
                <div style="margin-top:2rem;display:flex;gap:1.5rem;flex-wrap:wrap">
                    <div style="display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:var(--text-secondary)">
                        <i class="ri-truck-line" style="color:var(--accent)"></i>Free Shipping
                    </div>
                    <div style="display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:var(--text-secondary)">
                        <i class="ri-refresh-line" style="color:var(--accent)"></i>15 Day Returns
                    </div>
                    <div style="display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:var(--text-secondary)">
                        <i class="ri-shield-check-line" style="color:var(--accent)"></i>Authentic
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews -->
        <div class="reviews-section" data-aos="fade-up">
            <h3 style="font-size:1.3rem;text-transform:uppercase;margin-bottom:1.5rem">Reviews ({{ reviews|length }})
            </h3>
            {% for r in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="avatar">{{ r.name.0 }}</div>
                    <div>
                        <h4>{{ r.name }}</h4><span class="date">{{ r.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                <div class="review-stars">
                    {% for i in "12345" %}
                    {% if forloop.counter <= r.rating %}<i class="ri-star-fill"></i>{% else %}<i class="ri-star-line"
                            style="opacity:.3"></i>{% endif %}
                        {% endfor %}
                </div>
                <p class="review-text">{{ r.text }}</p>
            </div>
            {% empty %}
            <p style="color:var(--text-secondary)">No reviews yet. Be the first to review this product!</p>
            {% endfor %}

            <!-- Write Review Form -->
            {% if is_logged_in %}
            <div class="write-review-section"
                style="margin-top:2rem;padding:1.5rem;background:var(--card-bg);border:1px solid var(--border);border-radius:12px">
                <h4 style="font-size:1.1rem;text-transform:uppercase;margin-bottom:1rem;letter-spacing:.05em">Write a
                    Review</h4>
                <div style="margin-bottom:1rem">
                    <label style="display:block;font-size:.85rem;color:var(--text-secondary);margin-bottom:.4rem">Your
                        Rating</label>
                    <div class="star-rating-input" style="display:flex;gap:.3rem;font-size:1.5rem;cursor:pointer"
                        id="starRatingInput">
                        <i class="ri-star-line" data-star="1" onclick="setReviewStars(1)"></i>
                        <i class="ri-star-line" data-star="2" onclick="setReviewStars(2)"></i>
                        <i class="ri-star-line" data-star="3" onclick="setReviewStars(3)"></i>
                        <i class="ri-star-line" data-star="4" onclick="setReviewStars(4)"></i>
                        <i class="ri-star-line" data-star="5" onclick="setReviewStars(5)"></i>
                    </div>
                </div>
                <div style="margin-bottom:1rem">
                    <label style="display:block;font-size:.85rem;color:var(--text-secondary);margin-bottom:.4rem">Your
                        Review</label>
                    <textarea id="reviewText" rows="4" placeholder="Share your experience with this product..."
                        style="width:100%;padding:.8rem;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text-primary);font-size:.9rem;resize:vertical;font-family:inherit"></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitReview()" id="submitReviewBtn">
                    <i class="ri-send-plane-line"></i> Submit Review
                </button>
                <div id="reviewMsg" style="margin-top:.8rem;font-size:.85rem;display:none"></div>
            </div>
            {% else %}
            <div
                style="margin-top:1.5rem;padding:1rem;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;text-align:center">
                <p style="color:var(--text-secondary);margin:0"><a href="/login/?next={{ request.path }}"
                        style="color:var(--accent);text-decoration:underline">Sign in</a> to write a review</p>
            </div>
            {% endif %}
        </div>

        <!-- Related -->
        {% if related %}
        <div class="related-section" data-aos="fade-up">
            <h3 style="font-size:1.3rem;text-transform:uppercase;margin-bottom:1.5rem">You May Also Like</h3>
            <div class="products-grid">
                {% for p in related %}
                <div class="product-card">
                    <div class="product-img-wrap">
                        {% if p.badge %}
                        <span class="product-badge {% if p.badge == 'Limited' %}limited{% endif %}">{{ p.badge }}</span>
                        {% endif %}
                        <a href="{% url 'product_detail' p.slug %}"><img src="{{ p.image }}" alt="{{ p.name }}"
                                class="img-main"></a>
                    </div>
                    <div class="product-info">
                        <h3><a href="{% url 'product_detail' p.slug %}">{{ p.name }}</a></h3>
                        <div class="product-price"><span class="current">₹{{ p.price }}</span></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</section>

<script>
    let selectedSize = 'M';
    let selectedColor = '#000';

    function switchImg(thumb) {
        document.getElementById('mainImg').src = thumb.src;
        document.querySelectorAll('.gallery-thumbs img').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
    }

    function changeQty(d) {
        const inp = document.getElementById('qtyInput');
        const v = Math.max(1, Math.min(10, parseInt(inp.value) + d));
        inp.value = v;
    }

    async function addToCartDetail() {
        const qty = parseInt(document.getElementById('qtyInput').value);
        await addToCartAPI({{ product.id }}, selectedSize, selectedColor, qty);
  }

    // Gallery zoom
    const gallery = document.getElementById('mainGallery');
    const mainImg = document.getElementById('mainImg');
    gallery.addEventListener('mousemove', e => {
        const r = gallery.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100;
        const y = ((e.clientY - r.top) / r.height) * 100;
        mainImg.style.transformOrigin = `${x}% ${y}%`;
        mainImg.style.transform = 'scale(1.8)';
    });
    gallery.addEventListener('mouseleave', () => { mainImg.style.transform = 'scale(1)'; });

    // Review submission
    let reviewRating = 0;

    function setReviewStars(n) {
        reviewRating = n;
        const stars = document.querySelectorAll('#starRatingInput i');
        stars.forEach((s, i) => {
            s.className = i < n ? 'ri-star-fill' : 'ri-star-line';
            s.style.color = i < n ? '#ff9800' : 'var(--text-secondary)';
        });
    }

    // Hover effect for stars
    const starContainer = document.getElementById('starRatingInput');
    if (starContainer) {
        starContainer.querySelectorAll('i').forEach(star => {
            star.addEventListener('mouseenter', function () {
                const n = parseInt(this.dataset.star);
                starContainer.querySelectorAll('i').forEach((s, i) => {
                    s.className = i < n ? 'ri-star-fill' : 'ri-star-line';
                    s.style.color = i < n ? '#ff9800' : 'var(--text-secondary)';
                });
            });
        });
        starContainer.addEventListener('mouseleave', () => {
            starContainer.querySelectorAll('i').forEach((s, i) => {
                s.className = i < reviewRating ? 'ri-star-fill' : 'ri-star-line';
                s.style.color = i < reviewRating ? '#ff9800' : 'var(--text-secondary)';
            });
        });
    }

    async function submitReview() {
        const text = document.getElementById('reviewText').value.trim();
        const msg = document.getElementById('reviewMsg');
        const btn = document.getElementById('submitReviewBtn');

        if (reviewRating === 0) {
            msg.style.display = 'block';
            msg.style.color = '#e53e3e';
            msg.textContent = 'Please select a rating.';
            return;
        }
        if (!text) {
            msg.style.display = 'block';
            msg.style.color = '#e53e3e';
            msg.textContent = 'Please write a review.';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="ri-loader-4-line"></i> Submitting...';

        try {
            const res = await fetch('/api/review/{{ product.slug }}/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken')
                },
                body: JSON.stringify({ rating: reviewRating, text: text })
            });
            const data = await res.json();
            if (data.success) {
                msg.style.display = 'block';
                msg.style.color = '#38a169';
                msg.textContent = 'Review submitted successfully!';
                setTimeout(() => location.reload(), 1000);
            } else {
                msg.style.display = 'block';
                msg.style.color = '#e53e3e';
                msg.textContent = data.error || 'Failed to submit review.';
                btn.disabled = false;
                btn.innerHTML = '<i class="ri-send-plane-line"></i> Submit Review';
            }
        } catch (err) {
            msg.style.display = 'block';
            msg.style.color = '#e53e3e';
            msg.textContent = 'Network error. Please try again.';
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-send-plane-line"></i> Submit Review';
        }
    }

    function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
    }
</script>
{% endblock %}